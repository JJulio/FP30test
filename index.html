<!DOCTYPE html>
<html lang="en">
  <head>
    <title>WebMIDI examples</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<style>

    body{
	font-family:'Roboto',sans-serif;
	font-size:12pt;
	background-color:#eeeeee
	}
	
	h2{
	font-family:'Roboto',sans-serif;
	color:#777777;
	margin-left:8px;
	}
	
	select{
	font-size:12pt;
	border-radius: 4px;
	}
	
	button{
	font-size:12pt;
	border-radius: 4px;
	background-color:#bbccff;
	}
	
	div{
	margin:8px;
	}

.slider {
  -webkit-appearance: none;
  width: 256px;
  height: 15px;
  border-radius: 5px;  
  background: #d3d3d3;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 25px;
  height: 25px;
  border-radius: 40%; 
  background: #4080CC;
  cursor: pointer;
}

.slider::-moz-range-thumb {
  width: 25px;
  height: 25px;
  border-radius: 50%;
  background: #4080CC;
  cursor: pointer;
}
</style>
<script type="text/javascript">
var midi = null;  // global MIDIAccess object
var midiinput = null;
var midioutput = null;
var midiIn = [];
var midiOut = [];
var sounds=null;
var part=0;

var midiloopback = false;
var midilocal = true;

function reset(){
	if (midioutput)
      midioutput.send_message([0xb0,0x79,0x00]) //#Reset all
}

function setvolumen(value=127){
	$("#vol").text(value);
	if (midioutput)
		midioutput.send([0xb0+part,0x07,value]);
}

function setexpression(value=127){
	if (midioutput)
		midioutput.send([0xb0+part,0x11,value]);
}

function setreverb(value=0){
	$("#rev").text(value);
	if (midioutput)
		midioutput.send([0xb0+part,91,value]);
}

function setchorus(value=0){
	$("#cho").text(value);
	if (midioutput)
		midioutput.send([0xb0+part,93,value]);
}

function selectedSound(){
	var select = $("#selectSound")[0];
	var pc = sounds["voice"][select.selectedIndex]["PC"];
	var msb = sounds["voice"][select.selectedIndex]["MSB"];
	var lsb = sounds["voice"][select.selectedIndex]["LSB"];
	//alert (select.selectedIndex+" "+pc+" "+msb+" "+lsb);
	if (midioutput){
		midioutput.send([0xb0+part,0x00,msb]);  // bank msb  
		midioutput.send([0xb0+part,0x20,lsb]);  // bank lsb
		midioutput.send([0xc0+part,pc]);        // program change
		}
}

function echoMIDIMessage( event ) {
  //console.log(event.data)
  if (midiloopback && midioutput) {
    midioutput.send( event.data, event.timestamp );
  }
}

function initDevices(midi) {

  // MIDI devices that send you data.
  const inputs = midi.inputs.values();
  for (let input = inputs.next(); input && !input.done; input = inputs.next()) {
    midiIn.push(input.value);
  }
  
  // MIDI devices that you send data to.
  const outputs = midi.outputs.values();
  for (let output = outputs.next(); output && !output.done; output = outputs.next()) {
    midiOut.push(output.value);
  }
  
  var select = document.getElementById("selectInterface");
  var options = midiIn;
  for(var i = 0; i < options.length; i++) {
    var opt = options[i].name;
    var el = document.createElement("option");
    el.textContent = opt;
    el.value = opt;
    select.appendChild(el);
	}
  //displayDevices();
  //startListening();
}

function selectedInterface(){
  var selectint = document.getElementById("selectInterface");
  //alert(selectint.options[selectint.selectedIndex].index);
  var interfacename = midiIn[selectint.options[selectint.selectedIndex].index-1].name
  //alert(interfacename);
  // Search this name on midi outputs
  for (var i=0;i<midiOut.length;i++)
	if (midiOut[i].name == interfacename){
		// Connect midioutput
		midioutput = midiOut[i]
		alert("Connected to: "+midioutput.name)
		break;
	}
  midiinput = midiIn[selectint.options[selectint.selectedIndex].index-1]
  midiinput.onmidimessage = echoMIDIMessage;
  //alert(midiinput.name);
  // Reset
  reset();
  setvolumen(127);
  setexpression(127);
  setreverb(0x0e);
  setchorus(0);
}

function onMIDISuccess( midiAccess ) {
  
  console.log( "MIDI sucess!" );
  midi = midiAccess
  initDevices(midi);
  //if (!midiinput || !midioutput)
  //  console.log("Uh oh! Couldn't get i/o ports.");
}

function onMIDIFailure(msg) {
  console.log( "Failed to get MIDI access - " + msg );
  alert("Failed to get MIDI access - " + msg)
}

function selectmidilocal(cb){
	midilocal=cb.checked;
	// Send midi loopback command
	if (midilocal)
		data = [0xb0,0x7A,0x7F];
	else
		data = [0xb0,0x7A,0x00];
	midioutput.send(data);
}

function selectloopback(cb){
	midiloopback=cb.checked; 
}

function setup(){
	navigator.requestMIDIAccess({sysex:true}).then( onMIDISuccess, onMIDIFailure );
	$.getJSON( "https://jjulio.github.io/FP30test/sounds.json", function(data) {
		console.log( "sounds load success" );
		sounds = data["voices"]
		var select = $("#selectSound")[0];
		//var select = document.getElementById("selectSound");
		for(var i = 0; i < sounds["voice"].length; i++) {
			var opt = sounds["voice"][i]["Set"]+"-"+sounds["voice"][i]["Category"]+"-"+sounds["voice"][i]["content"];
			var el = document.createElement("option");
			el.textContent = opt;
			el.value = opt;
			select.appendChild(el);
			}
		});
}
</script>
</head>
<body onload="setup();">
	<h2>FP30 Playground</h2>
	<div><select id="selectInterface">
	<option>Choose Midi interface</option>
	</select>
	<button onclick="selectedInterface()">Connect!</button>
	</div>
	<div>
		<input type="checkbox" id="cbox1" checked=true onchange="selectmidilocal(this);"> <label>Main keyboard (Midi local)</label>
	</div>
	<div>	
		<input type="checkbox" id="cbox2" onchange="selectloopback(this);"> <label>Added sounds (Midi loopback)</label>
	</div>
	<div>
		<select id="selectSound"></select>
		<button onclick="selectedSound()">Set sound</button>
	</div>
	<div><input type="range" min="0" max="127" value="127" class="slider" id="volumen" oninput="setvolumen(this.value);"><label>&nbsp;Volumen&nbsp;-&nbsp;</label><label id="vol">127</label></div>
	<div><input type="range" min="0" max="127" value="0" class="slider" id="reverb" oninput="setreverb(this.value);"><label>&nbsp;Reverb&nbsp;-&nbsp;</label><label id="rev">0</label></div>
	<div><input type="range" min="0" max="127" value="0" class="slider" id="chorus" oninput="setchorus(this.value);"><label>&nbsp;Chorus&nbsp;-&nbsp;</label><label id="cho">0</label></div>
</body>
</html>
